<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Suprematism Evolver</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Anton&family=Space+Grotesk:wght@400;500;600;700&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#111;
  --surface:#1a1917;
  --surface-soft:#1e1c19;
  --surface-muted:#2a2825;
  --border:rgba(255,255,255,.1);
  --border-strong:#f4f1ec;
  --text:#f4f1ec;
  --text-dim:#8a847b;
  --red:#cc0000;
  --blue:#3377cc;
  --yellow:#e8c800;
  --ok:#15b04e;
  --shadow:0 8px 30px rgba(0,0,0,.3);
  --radius:10px;
  --sidebar:320px;
  --header-h:72px;
}
html{color-scheme:dark}
html,body{
  font-family:'Space Grotesk','Inter',system-ui,-apple-system,sans-serif;
  background:var(--bg);
  color:var(--text);
  height:100%;
}
body{display:flex;flex-direction:column;overflow:hidden}

.header{
  height:var(--header-h);
  background:transparent;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 24px;
  gap:16px;
  flex-shrink:0;
}
.brand{
  display:flex;
  align-items:center;
  min-width:0;
}
.brand h1{
  font-family:'Anton',sans-serif;
  font-size:1.9rem;
  letter-spacing:.13em;
  font-weight:400;
  text-transform:uppercase;
  white-space:nowrap;
}
.brand .red{color:var(--red)}
.brand .blue{color:var(--blue)}
.brand .yellow{color:var(--yellow)}

.top-nav{
  display:flex;
  align-items:center;
  gap:18px;
}
.top-nav .route-link{
  text-decoration:none;
  color:var(--text-dim);
  font-size:.78rem;
  text-transform:uppercase;
  letter-spacing:.08em;
  font-weight:700;
  padding:2px 0;
  border-bottom:2px solid transparent;
  transition:all .15s ease;
}
.top-nav .route-link.active{
  color:var(--text);
  border-bottom-color:var(--red);
}

.pages{
  flex:1;
  min-height:0;
}
.page{
  display:none;
  height:100%;
}
.page.active{display:block}

/* ---------- Home ---------- */
.home{
  overflow-y:auto;
  padding:26px;
}
.home-wrap{
  max-width:1280px;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:24px;
}
.home-hero{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:26px;
  display:grid;
  grid-template-columns:1.5fr 1fr;
  gap:18px;
}
.hero-copy h2{
  font-size:2rem;
  line-height:1.15;
  letter-spacing:-.02em;
  margin-bottom:10px;
}
.hero-copy p{
  color:var(--text-dim);
  line-height:1.7;
  max-width:64ch;
}
.hero-actions{
  margin-top:16px;
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-size:.8rem;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.05em;
  padding:11px 14px;
  transition:all .15s ease;
  font-family:inherit;
}
.btn-primary{background:var(--red);color:#fff}
.btn-primary:hover:not(:disabled){background:#dc1414}
.btn-secondary{background:var(--surface-muted);color:var(--text)}
.btn-secondary:hover:not(:disabled){background:rgba(255,255,255,.12)}
.btn-danger{background:#333;color:var(--text)}
.btn-danger:hover:not(:disabled){background:#444}
.btn:disabled{opacity:.4;cursor:not-allowed}

.hero-stats{
  background:var(--surface-soft);
  border:1px solid var(--border);
  border-radius:10px;
  padding:16px;
  display:grid;
  gap:12px;
  align-content:start;
}
.stat-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.stat-row .label{
  font-size:.68rem;
  text-transform:uppercase;
  letter-spacing:.07em;
  color:var(--text-dim);
  font-weight:700;
}
.stat-row .value{
  font-size:.95rem;
  font-weight:700;
}
.engine-chip{
  border:1px solid var(--border);
  background:var(--surface);
  border-radius:999px;
  font-size:.72rem;
  color:var(--text-dim);
  padding:4px 10px;
  text-transform:uppercase;
  letter-spacing:.06em;
}

.home-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
}
.home-card-head{
  display:flex;
  align-items:end;
  justify-content:space-between;
  gap:12px;
  margin-bottom:14px;
}
.home-card-head h3{
  font-size:1.1rem;
  letter-spacing:-.01em;
}
.home-card-head p{
  color:var(--text-dim);
  font-size:.86rem;
}
.mini-note{
  font-size:.74rem;
  color:var(--text-dim);
}
.gallery-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:10px;
}
.art-thumb{
  background:var(--surface-soft);
  border:1px solid var(--border);
  border-radius:8px;
  overflow:hidden;
  aspect-ratio:1;
}
.art-thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
.empty-state{
  color:var(--text-dim);
  border:1px dashed var(--border);
  border-radius:8px;
  padding:20px;
  text-align:center;
}
.dual-style{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
}
.style-panel h4{
  font-size:1rem;
  margin-bottom:6px;
}
.style-panel p{
  color:var(--text-dim);
  font-size:.86rem;
  margin-bottom:10px;
  line-height:1.5;
}
.how-grid{
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
  gap:12px;
}
.how-step{
  border:1px solid var(--border);
  border-radius:8px;
  background:var(--surface-soft);
  padding:12px;
}
.how-step .step-no{
  width:26px;
  height:26px;
  border-radius:50%;
  background:var(--border-strong);
  color:#fff;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:.73rem;
  font-weight:700;
  margin-bottom:8px;
}
.how-step strong{
  display:block;
  font-size:.86rem;
  margin-bottom:4px;
}
.how-step span{
  display:block;
  font-size:.8rem;
  color:var(--text-dim);
  line-height:1.45;
}

/* ---------- Infographic ---------- */
.infographic-card{
  padding:0!important;
  overflow:hidden;
}
.infographic{padding:48px 36px 36px}
.infographic-header{text-align:center;margin-bottom:44px}
.infographic-header h3{
  font-family:'Anton',sans-serif;
  font-size:2.2rem;
  letter-spacing:.12em;
  text-transform:uppercase;
  color:#fff;
  font-weight:400;
  margin-bottom:4px;
}
.infographic-header p{
  color:rgba(244,241,236,.5);
  font-size:.88rem;
  line-height:1.6;
}
.infographic-steps{
  display:flex;flex-direction:column;
  gap:0;max-width:920px;margin:0 auto;
}
.ig-step{
  padding:26px 28px;
  background:rgba(255,255,255,.025);
  border:1px solid rgba(255,255,255,.06);
  border-radius:12px;
}
.ig-step-head{
  display:flex;align-items:center;
  gap:14px;margin-bottom:14px;
}
.ig-step-num{
  width:42px;height:42px;border-radius:50%;
  background:var(--red);color:#fff;
  font-family:'Anton',sans-serif;font-size:1.05rem;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;letter-spacing:.04em;
}
.ig-step-num.blue{background:var(--blue)}
.ig-step-num.yellow{background:var(--yellow);color:#1a1917}
.ig-step-num.dark{background:#333;color:#fff}
.ig-step-head h4{
  font-size:1.05rem;font-weight:700;
  letter-spacing:.01em;color:#fff;
}
.ig-step-desc{
  color:rgba(244,241,236,.6);
  font-size:.84rem;line-height:1.65;
  margin-bottom:18px;max-width:640px;
}
.ig-step-desc strong{color:#fff}
.ig-grid{
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:8px;margin-bottom:16px;
}
.ig-img{
  aspect-ratio:1;border-radius:6px;
  overflow:hidden;
  border:2px solid rgba(255,255,255,.08);
  position:relative;
  transition:all .3s ease;
}
.ig-img img{width:100%;height:100%;object-fit:cover;display:block}
.ig-img.ig-selected{
  border-color:var(--red);
  box-shadow:0 0 20px rgba(204,0,0,.4),0 0 0 1px var(--red);
  transform:scale(1.04);z-index:1;
}
.ig-img.ig-selected::after{
  content:'âœ“';
  position:absolute;top:5px;right:5px;
  width:20px;height:20px;border-radius:50%;
  background:var(--red);color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-size:.65rem;font-weight:700;
}
.ig-math{
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.07);
  border-radius:8px;padding:14px 18px;
  font-family:'Courier New','Menlo',monospace;
  font-size:.78rem;line-height:1.85;
  color:rgba(244,241,236,.75);
  overflow-x:auto;
}
.ig-math+.ig-math{margin-top:10px}
.ig-math-label{
  color:var(--yellow);
  font-family:'Space Grotesk',sans-serif;
  font-weight:700;font-size:.63rem;
  text-transform:uppercase;letter-spacing:.11em;
  display:block;margin-bottom:4px;
}
.ig-math .v{color:#7cb7ff}
.ig-math .op{color:var(--red)}
.ig-math .kw{color:var(--yellow)}
.ig-crossover{
  display:flex;align-items:center;
  justify-content:center;gap:18px;
  margin:20px 0;flex-wrap:wrap;
}
.ig-crossover .ig-par{text-align:center}
.ig-crossover .ig-par img{
  width:120px;height:120px;
  border-radius:8px;display:block;
  border:2px solid rgba(255,255,255,.1);
}
.ig-crossover .ig-par .lbl{
  font-size:.68rem;margin-top:6px;
  color:rgba(244,241,236,.45);
  text-transform:uppercase;letter-spacing:.07em;
}
.ig-crossover .ig-sym{
  font-family:'Anton',sans-serif;
  font-size:1.6rem;
  color:rgba(244,241,236,.25);
}
.ig-crossover .ig-child-wrap{text-align:center}
.ig-crossover .ig-child-wrap img{
  width:140px;height:140px;
  border-radius:10px;display:block;
  border:2px solid var(--yellow);
  box-shadow:0 0 28px rgba(232,200,0,.2);
}
.ig-crossover .ig-child-wrap .lbl{
  font-size:.68rem;margin-top:6px;
  color:var(--yellow);
  text-transform:uppercase;letter-spacing:.07em;
  font-weight:700;
}
.ig-connector{
  display:flex;justify-content:center;
  padding:6px 0;
}
.ig-connector span{
  display:block;width:2px;height:28px;
  background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.04));
  border-radius:1px;
}
.ig-regen{
  display:flex;justify-content:center;margin-top:16px;
}
.ig-regen button{
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.1);
  color:rgba(244,241,236,.55);
  border-radius:8px;padding:9px 18px;
  font-size:.75rem;font-weight:600;
  font-family:inherit;text-transform:uppercase;
  letter-spacing:.06em;cursor:pointer;
  transition:all .15s ease;
}
.ig-regen button:hover{
  background:rgba(255,255,255,.1);color:#fff;
}
.ig-loading{
  text-align:center;padding:48px 20px;
  color:rgba(244,241,236,.35);
  font-size:.88rem;
}
@media(max-width:900px){
  .ig-grid{grid-template-columns:repeat(3,1fr)}
  .infographic{padding:28px 16px}
  .ig-crossover .ig-par img{width:96px;height:96px}
  .ig-crossover .ig-child-wrap img{width:110px;height:110px}
}
@media(max-width:620px){
  .infographic-header h3{font-size:1.5rem}
  .ig-step{padding:18px 16px}
  .ig-crossover{gap:12px}
  .ig-crossover .ig-par img{width:80px;height:80px}
  .ig-crossover .ig-child-wrap img{width:96px;height:96px}
}

/* ---------- Evolve ---------- */
.app-body{
  height:100%;
  display:flex;
  min-height:0;
}
.sidebar{
  width:var(--sidebar);
  flex-shrink:0;
  background:transparent;
  border-right:none;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow-y:auto;
}
.panel-card{
  border:none;
  border-radius:0;
  background:transparent;
  padding:0;
}
.panel-head{
  font-size:.66rem;
  text-transform:uppercase;
  letter-spacing:.11em;
  color:var(--text-dim);
  font-weight:700;
  margin-bottom:8px;
}
.panel-hint{
  font-size:.72rem;
  color:var(--text-dim);
  line-height:1.5;
  margin-top:8px;
}
.gen-nav{
  display:flex;
  align-items:center;
  gap:8px;
}
.gen-badge{
  flex:1;
  text-align:left;
  background:transparent;
  color:var(--text);
  border-radius:0;
  font-size:.84rem;
  font-weight:600;
  padding:0;
}
.gen-badge strong{color:var(--red)}
.btn-nav{
  border:1px solid var(--border);
  width:34px;
  height:34px;
  border-radius:8px;
  background:transparent;
  color:var(--text);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.btn-nav:hover:not(:disabled){background:rgba(255,255,255,.08)}
.btn-nav:disabled{opacity:.35;cursor:not-allowed}
.btn-nav svg{width:16px;height:16px}

.control-row{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-bottom:10px;
}
.control-row:last-child{margin-bottom:0}
.control-row label{
  font-size:.68rem;
  text-transform:uppercase;
  letter-spacing:.05em;
  color:var(--text-dim);
  font-weight:700;
}
.control-row select{
  width:100%;
  border:1px solid var(--border);
  border-radius:8px;
  background:var(--surface);
  color:var(--text);
  font-size:.83rem;
  font-weight:600;
  padding:8px 10px;
  font-family:inherit;
}
.control-row select:focus{outline:2px solid rgba(204,0,0,.2);border-color:var(--red)}

.slider-row{
  display:flex;
  align-items:center;
  gap:10px;
}
.slider-row input[type="range"]{
  -webkit-appearance:none;
  appearance:none;
  flex:1;
  height:4px;
  border-radius:999px;
  background:rgba(255,255,255,.15);
}
.slider-row input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:14px;
  height:14px;
  border-radius:50%;
  background:var(--red);
  box-shadow:0 1px 4px rgba(0,0,0,.2);
}
.slider-row input[type="range"]::-moz-range-thumb{
  width:14px;
  height:14px;
  border-radius:50%;
  border:none;
  background:var(--red);
}
.range-val{
  min-width:2.2em;
  text-align:right;
  font-weight:700;
  font-size:.77rem;
}

.action-stack{display:flex;flex-direction:column;gap:8px}
.btn-row{display:flex;gap:8px}
.btn-row .btn{flex:1}
.selection-info{
  font-size:.78rem;
  color:var(--text-dim);
  line-height:1.55;
  min-height:1.2em;
}
.sidebar-footer{
  margin-top:auto;
  border:none;
  border-radius:0;
  padding:4px 0 0;
  font-size:.73rem;
  color:var(--text-dim);
  line-height:1.55;
}

.collapse-toggle{
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
}
.collapse-toggle .chevron{
  width:14px;
  height:14px;
  color:var(--text-dim);
  transition:transform .2s ease;
}
.collapse-toggle.open .chevron{transform:rotate(180deg)}
.collapse-body{
  max-height:0;
  overflow:hidden;
  transition:max-height .24s ease;
}
.collapse-body.open{max-height:520px}
.collapse-inner{padding-top:10px}

.grid-area{
  flex:1;
  min-width:0;
  overflow-y:auto;
  padding:16px;
}
.grid{
  width:100%;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(clamp(150px,16vw,210px),1fr));
  gap:12px;
}
.cell{
  position:relative;
  aspect-ratio:1;
  border:2px solid var(--border);
  border-radius:8px;
  overflow:hidden;
  background:var(--surface);
  cursor:pointer;
  transition:transform .14s ease,border-color .14s ease,box-shadow .14s ease;
}
.cell img{width:100%;height:100%;object-fit:cover;display:block}
.cell:hover{
  transform:translateY(-1px);
  box-shadow:0 6px 24px rgba(0,0,0,.12);
}
.cell.selected{
  border-color:var(--red);
  box-shadow:0 0 0 1px var(--red),0 6px 24px rgba(204,0,0,.15);
}
.cell .idx{
  position:absolute;
  top:5px;
  left:5px;
  background:rgba(0,0,0,.55);
  color:#fff;
  border-radius:6px;
  font-size:.68rem;
  font-weight:700;
  padding:2px 6px;
}
.cell .check{
  position:absolute;
  top:5px;
  right:5px;
  width:22px;
  height:22px;
  border-radius:50%;
  border:2px solid rgba(255,255,255,.2);
  background:rgba(255,255,255,.15);
  display:flex;
  align-items:center;
  justify-content:center;
}
.cell.selected .check{
  background:var(--red);
  border-color:var(--red);
}
.cell .check svg{
  width:14px;
  height:14px;
  opacity:0;
  transition:opacity .14s ease;
}
.cell.selected .check svg{opacity:1}

.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:200;
}
.overlay.hidden{display:none}
.spinner{
  width:46px;
  height:46px;
  border-radius:50%;
  border:4px solid var(--border);
  border-top-color:var(--red);
  animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.58);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:300;
}
.modal-backdrop.hidden{display:none}
.modal{
  max-width:90vw;
  max-height:90vh;
  background:var(--surface);
  border-radius:10px;
  border:1px solid var(--border);
  padding:16px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}
.modal img{
  max-width:80vw;
  max-height:72vh;
  border-radius:8px;
}
.modal-actions{
  display:flex;
  gap:8px;
}

@media(max-width:1100px){
  .home-hero{grid-template-columns:1fr}
  .dual-style{grid-template-columns:1fr}
  .how-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
}
@media(max-width:900px){
  .header{
    padding:0 12px;
    height:auto;
    min-height:var(--header-h);
    flex-wrap:wrap;
    justify-content:center;
    padding-block:10px;
  }
  .brand h1{font-size:1.5rem}
  .app-body{flex-direction:column}
  .sidebar{
    width:100%;
    border-right:none;
    border-bottom:none;
    max-height:52vh;
  }
  .home{padding:14px}
  .grid{
    grid-template-columns:repeat(auto-fit,minmax(138px,1fr));
    gap:10px;
  }
}
@media(max-width:620px){
  .how-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<header class="header">
  <div class="brand">
    <h1>Supr<span class="red">e</span><span class="blue">m</span><span class="yellow">a</span>t<span class="red">i</span>s<span class="blue">m</span> <span class="yellow">E</span><span class="red">v</span>o<span class="blue">l</span><span class="yellow">v</span><span class="red">e</span>r</h1>
  </div>
  <nav class="top-nav" aria-label="Primary">
    <a href="/" class="route-link" data-route="home">Home</a>
    <a href="/evolve" class="route-link" data-route="evolve">Evolve</a>
  </nav>
</header>

<div class="pages">
  <section class="page home" id="page-home">
    <div class="home-wrap">
      <article class="home-hero">
        <div class="hero-copy">
          <h2>Evolving abstract compositions inspired by Malevich and Hadid</h2>
          <p>
            This system uses interactive evolution: each generation produces a grid of paintings, you pick the strongest ones,
            and the engine breeds a new generation by recombining and mutating those visual genes. Over time, your taste guides
            the search toward compositions you want to keep.
          </p>
          <div class="hero-actions">
            <button class="btn btn-primary" id="home-start">Start evolving</button>
            <button class="btn btn-secondary" id="home-refresh">Refresh galleries</button>
          </div>
        </div>
        <div class="hero-stats">
          <div class="stat-row">
            <span class="label">Current Generation</span>
            <span class="value" id="home-gen">-</span>
          </div>
          <div class="stat-row">
            <span class="label">Population</span>
            <span class="value" id="home-pop">-</span>
          </div>
          <div class="stat-row">
            <span class="label">Active Engine</span>
            <span class="engine-chip" id="home-engine-chip">-</span>
          </div>
          <div class="mini-note" id="home-live-meta">Loading latest generation...</div>
        </div>
      </article>

      <article class="home-card">
        <div class="home-card-head">
          <div>
            <h3>Live evolving paintings</h3>
            <p>A snapshot from the current generation in your session.</p>
          </div>
          <button class="btn btn-secondary" id="home-go-evolve">Open evolve workspace</button>
        </div>
        <div class="gallery-grid" id="home-live-grid"></div>
      </article>

      <article class="home-card">
        <div class="home-card-head">
          <div>
            <h3>Style galleries</h3>
            <p>Two visual directions generated by different genome constraints.</p>
          </div>
          <span class="mini-note">Generated server-side from the same renderers used in Evolve.</span>
        </div>
        <div class="dual-style">
          <div class="style-panel">
            <h4>Malevich-inspired (Shapes)</h4>
            <p>Flat Suprematist compositions using geometric groups, satellites, texture, and painterly edge treatment.</p>
            <div class="gallery-grid" id="home-malevich-grid"></div>
          </div>
          <div class="style-panel">
            <h4>Zaha Hadid-inspired (Hadid 3D)</h4>
            <p>Oblique projected architectons with elevation, depth shading, dramatic diagonal fields, and structural clusters.</p>
            <div class="gallery-grid" id="home-hadid-grid"></div>
          </div>
          <div class="style-panel">
            <h4>City Plans (Maps 3D)</h4>
            <p>Abstract urban compositions inspired by master plans: axial boulevards, radial streets, hexagonal blocks, garden districts.</p>
            <div class="gallery-grid" id="home-maps-grid"></div>
          </div>
        </div>
      </article>

      <article class="home-card infographic-card">
        <div class="infographic">
          <div class="infographic-header">
            <h3>The Evolution of Art</h3>
            <p>How a genetic algorithm turns your aesthetic taste into paintings</p>
          </div>
          <div class="infographic-steps" id="ig-steps">
            <div class="ig-loading">Generating evolution demo&hellip;</div>
          </div>
          <div class="ig-regen">
            <button id="ig-regen-btn">&circlearrowright; Regenerate demo</button>
          </div>
        </div>
      </article>
    </div>
  </section>

  <section class="page" id="page-evolve">
    <div class="app-body">
      <aside class="sidebar">
        <div class="panel-card">
          <div class="panel-head">Generation</div>
          <div class="gen-nav">
            <button class="btn-nav" id="btn-prev" disabled title="Previous generation (Left arrow)">
              <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10 3L5 8l5 5"/></svg>
            </button>
            <div class="gen-badge">Gen <strong id="gen-num">0</strong></div>
            <button class="btn-nav" id="btn-next" disabled title="Next generation (Right arrow)">
              <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M6 3l5 5-5 5"/></svg>
            </button>
          </div>
          <p class="panel-hint">Navigate your history with arrow keys.</p>
        </div>

        <div class="panel-card">
          <div class="panel-head">Core controls</div>
          <div class="control-row">
            <label for="sel-engine">Engine</label>
            <select id="sel-engine">
              <option value="shapes" selected>Shapes</option>
              <option value="hadid">Hadid 3D</option>
              <option value="maps">Maps 3D</option>
              <option value="cppn">CPPN</option>
            </select>
          </div>
          <div class="control-row cppn-only">
            <label for="sel-mode">Mode</label>
            <select id="sel-mode">
              <option value="malevich" selected>Malevich</option>
            </select>
          </div>
          <div class="control-row cppn-only">
            <label for="sel-palette">Palette</label>
            <select id="sel-palette">
              <option value="none" selected>Full Color</option>
              <option value="malevich">Suprematist</option>
            </select>
          </div>
          <div class="control-row cppn-only">
            <label for="sel-color">Color</label>
            <select id="sel-color">
              <option value="rgb" selected>RGB</option>
              <option value="hsv">HSV</option>
            </select>
          </div>
          <div class="control-row">
            <label for="sl-mutation">Mutation rate</label>
            <div class="slider-row">
              <input type="range" id="sl-mutation" min="0" max="3" step="0.1" value="1">
              <span class="range-val" id="mutation-val">1.0</span>
            </div>
          </div>
        </div>

        <div class="panel-card">
          <div class="collapse-toggle" id="adv-toggle">
            <div class="panel-head" style="margin-bottom:0">Advanced</div>
            <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 6l4 4 4-4"/></svg>
          </div>
          <div class="collapse-body" id="adv-body">
            <div class="collapse-inner">
              <div class="control-row">
                <label for="sl-crossover">Crossover rate</label>
                <div class="slider-row">
                  <input type="range" id="sl-crossover" min="0" max="1" step="0.05" value="0.7">
                  <span class="range-val" id="crossover-val">0.7</span>
                </div>
              </div>
              <div class="control-row">
                <label for="sl-grain">Grain</label>
                <div class="slider-row">
                  <input type="range" id="sl-grain" min="0" max="25" step="1" value="8">
                  <span class="range-val" id="grain-val">8</span>
                </div>
              </div>
              <div class="control-row">
                <label for="sl-gradient">Color gradient</label>
                <div class="slider-row">
                  <input type="range" id="sl-gradient" min="0" max="25" step="1" value="10">
                  <span class="range-val" id="gradient-val">10</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="panel-card">
          <div class="panel-head">Actions</div>
          <div class="action-stack">
            <button class="btn btn-primary" id="btn-evolve" disabled>
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M2 8h12M10 4l4 4-4 4"/></svg>
              Evolve
            </button>
            <div class="btn-row">
              <button class="btn btn-secondary" id="btn-export" disabled>Export</button>
              <button class="btn btn-secondary" id="btn-export-land" disabled title="Landscape">
                <svg width="14" height="10" viewBox="0 0 14 10" fill="none" stroke="currentColor" stroke-width="1.5"><rect x=".75" y=".75" width="12.5" height="8.5" rx="1"/></svg>
              </button>
              <button class="btn btn-secondary" id="btn-export-port" disabled title="Portrait">
                <svg width="10" height="14" viewBox="0 0 10 14" fill="none" stroke="currentColor" stroke-width="1.5"><rect x=".75" y=".75" width="8.5" height="12.5" rx="1"/></svg>
              </button>
            </div>
            <div class="btn-row">
              <button class="btn btn-secondary" id="btn-export-all">Export all</button>
            </div>
            <div class="btn-row">
              <button class="btn btn-secondary" id="btn-save" disabled>Save</button>
              <button class="btn btn-danger" id="btn-reset">Reset</button>
            </div>
          </div>
        </div>

        <div class="panel-card">
          <div class="panel-head">Selection</div>
          <span class="selection-info" id="sel-info">Click thumbnails to select parents</span>
        </div>

        <div class="sidebar-footer">
          Evolutionary art engine inspired by Kazimir Malevich and Zaha Hadid. Select, evolve, iterate.
        </div>
      </aside>

      <main class="grid-area">
        <div class="grid" id="grid"></div>
      </main>
    </div>
  </section>
</div>

<div class="overlay hidden" id="loading"><div class="spinner"></div></div>

<div class="modal-backdrop hidden" id="modal-backdrop">
  <div class="modal">
    <img id="modal-img" src="" alt="Hi-res export">
    <div class="modal-actions">
      <a class="btn btn-primary" id="modal-download" download="export.png" href="#">Download</a>
      <button class="btn btn-secondary" id="modal-close">Close</button>
    </div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);

const pageHome = $('#page-home');
const pageEvolve = $('#page-evolve');
const routeLinks = [...document.querySelectorAll('.route-link')];
const homeStart = $('#home-start');
const homeRefresh = $('#home-refresh');
const homeGoEvolve = $('#home-go-evolve');
const homeLiveGrid = $('#home-live-grid');
const homeMalevichGrid = $('#home-malevich-grid');
const homeHadidGrid = $('#home-hadid-grid');
const homeMapsGrid = $('#home-maps-grid');
const homeGen = $('#home-gen');
const homePop = $('#home-pop');
const homeLiveMeta = $('#home-live-meta');
const homeEngineChip = $('#home-engine-chip');

const grid = $('#grid');
const loading = $('#loading');
const genNum = $('#gen-num');
const selInfo = $('#sel-info');
const btnEvolve = $('#btn-evolve');
const btnExport = $('#btn-export');
const btnExportLand = $('#btn-export-land');
const btnExportPort = $('#btn-export-port');
const btnExportAll = $('#btn-export-all');
const btnSave = $('#btn-save');
const btnReset = $('#btn-reset');
const btnPrev = $('#btn-prev');
const btnNext = $('#btn-next');
const selEngine = $('#sel-engine');
const selMode = $('#sel-mode');
const selPalette = $('#sel-palette');
const selColor = $('#sel-color');
const slMutation = $('#sl-mutation');
const mutationVal = $('#mutation-val');
const slCrossover = $('#sl-crossover');
const crossoverVal = $('#crossover-val');
const slGrain = $('#sl-grain');
const grainVal = $('#grain-val');
const slGradient = $('#sl-gradient');
const gradientVal = $('#gradient-val');
const advToggle = $('#adv-toggle');
const advBody = $('#adv-body');
const cppnControls = document.querySelectorAll('.cppn-only');
const modalBackdrop = $('#modal-backdrop');
const modalImg = $('#modal-img');
const modalDownload = $('#modal-download');
const modalClose = $('#modal-close');

let activeRoute = 'home';
let selected = new Set();
let thumbnails = [];
let popSize = 0;
let currentEngine = 'shapes';
let evolveLoaded = false;
let homeSamplesCache = null;

function showLoading(){ loading.classList.remove('hidden'); }
function hideLoading(){ loading.classList.add('hidden'); }

async function apiFetch(url, body, withLoading = true){
  if(withLoading) showLoading();
  try{
    const opts = body !== undefined
      ? { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }
      : {};
    const res = await fetch(url, opts);
    if(!res.ok){
      const text = await res.text();
      throw new Error(text || `Request failed: ${res.status}`);
    }
    return await res.json();
  } finally {
    if(withLoading) hideLoading();
  }
}

function engineLabel(engine){
  if(engine === 'hadid') return 'Hadid 3D';
  if(engine === 'maps') return 'Maps 3D';
  if(engine === 'cppn') return 'CPPN';
  return 'Shapes';
}

function updateEngineUI(engine){
  currentEngine = engine;
  selEngine.value = engine;
  cppnControls.forEach(el => el.style.display = engine === 'cppn' ? '' : 'none');
  homeEngineChip.textContent = engineLabel(engine);
}

function updateNavUI(data){
  btnPrev.disabled = !data.has_prev;
  btnNext.disabled = !data.has_next;
}

function updateSelectionUI(){
  const count = selected.size;
  btnEvolve.disabled = count === 0;
  const singleSelected = count === 1;
  btnExport.disabled = !singleSelected;
  btnExportLand.disabled = !singleSelected;
  btnExportPort.disabled = !singleSelected;
  btnSave.disabled = !singleSelected;

  if(count === 0) selInfo.textContent = 'Click thumbnails to select parents';
  else selInfo.textContent = `${count} selected: [${[...selected].sort((a,b)=>a-b).join(', ')}]`;

  document.querySelectorAll('.cell').forEach((el, i) => {
    el.classList.toggle('selected', selected.has(i));
  });
}

function renderHomeGallery(container, images){
  if(!images || images.length === 0){
    container.innerHTML = '<div class="empty-state">No images available yet.</div>';
    return;
  }
  container.innerHTML = images.map((b64, i) => `
    <div class="art-thumb" title="Artwork ${i}">
      <img src="data:image/png;base64,${b64}" alt="Artwork ${i}">
    </div>
  `).join('');
}

async function loadInfographic(refresh){
  const box = document.getElementById('ig-steps');
  if(!box) return;
  box.innerHTML = '<div class="ig-loading">Generating evolution demo&hellip;</div>';
  try{
    const url = refresh ? '/api/infographic?refresh=1' : '/api/infographic';
    const d = await apiFetch(url, undefined, false);
    const sel = new Set(d.selected);
    box.innerHTML =
      '<div class="ig-step">'+
        '<div class="ig-step-head">'+
          '<div class="ig-step-num">01</div>'+
          '<h4>The Genome &mdash; Random Initialization</h4>'+
        '</div>'+
        '<p class="ig-step-desc">'+
          'A population of artworks is generated randomly. Each painting is encoded as a '+
          '<strong>genome</strong> &mdash; a hierarchical tree of shape groups, where every shape '+
          'carries evolvable parameters for position, size, rotation, color, and opacity.'+
        '</p>'+
        '<div class="ig-grid">'+
          d.parents.map(function(b,i){
            return '<div class="ig-img"><img src="data:image/png;base64,'+b+'" alt="Genome '+i+'"></div>';
          }).join('')+
        '</div>'+
        '<div class="ig-math">'+
          '<span class="ig-math-label">Genome Structure</span>'+
          '<span class="v">G</span> = { groups: [<span class="v">G\u2081</span>, <span class="v">G\u2082</span>, \u2026, <span class="v">G\u2099</span>] }<br>'+
          '<span class="v">G\u1d62</span> = { anchor: <span class="kw">Shape</span>, satellites: [<span class="v">S\u2081</span>, \u2026, <span class="v">S\u2098</span>] }<br>'+
          '<span class="kw">Shape</span> = (<span class="v">kind</span>, <span class="v">x</span>, <span class="v">y</span>, <span class="v">w</span>, <span class="v">h</span>, <span class="v">\u03b8</span>, <span class="v">color</span>, <span class="v">\u03b1</span>)<br>'+
          '<br>'+
          '<span class="v">x</span>, <span class="v">y</span>, <span class="v">w</span>, <span class="v">h</span> <span class="op">\u2208</span> [0, 1] &nbsp;&nbsp; '+
          '<span class="v">\u03b8</span> <span class="op">\u2208</span> [0, 2\u03c0] &nbsp;&nbsp; '+
          '<span class="v">\u03b1</span> <span class="op">\u2208</span> [0, 1]<br>'+
          '<span class="v">kind</span> <span class="op">\u2208</span> { square, rect, circle, cross, trapezoid, triangle, line, ellipse, semicircle }'+
        '</div>'+
      '</div>'+
      '<div class="ig-connector"><span></span></div>'+
      '<div class="ig-step">'+
        '<div class="ig-step-head">'+
          '<div class="ig-step-num blue">02</div>'+
          '<h4>Interactive Selection &mdash; You Are the Fitness Function</h4>'+
        '</div>'+
        '<p class="ig-step-desc">'+
          'In traditional evolution, nature selects the fittest. Here, <strong>you</strong> are the '+
          'selective pressure. Click the paintings you find most compelling &mdash; they become parents '+
          'of the next generation.'+
        '</p>'+
        '<div class="ig-grid">'+
          d.parents.map(function(b,i){
            return '<div class="ig-img'+(sel.has(i)?' ig-selected':'')+'"><img src="data:image/png;base64,'+b+'" alt="Genome '+i+'"></div>';
          }).join('')+
        '</div>'+
        '<div class="ig-math">'+
          '<span class="ig-math-label">Fitness Function (Interactive Evolution)</span>'+
          '<span class="v">f</span>(<span class="v">G</span>) <span class="op">=</span> '+
          '1 &nbsp;if selected by user, &nbsp;0 &nbsp;otherwise<br>'+
          '<br>'+
          '<span class="ig-math-label">Tournament Selection (k = 3)</span>'+
          'Pick <span class="v">k</span> random individuals from the population \u2192<br>'+
          'the one with highest <span class="v">f</span>(<span class="v">G</span>) becomes a parent for crossover'+
        '</div>'+
      '</div>'+
      '<div class="ig-connector"><span></span></div>'+
      '<div class="ig-step">'+
        '<div class="ig-step-head">'+
          '<div class="ig-step-num yellow">03</div>'+
          '<h4>Crossover + Mutation &mdash; Breeding New Art</h4>'+
        '</div>'+
        '<p class="ig-step-desc">'+
          'Selected parents are paired. Their genomes are recombined via <strong>uniform crossover</strong>, '+
          'then each gene is randomly <strong>mutated</strong> with Gaussian noise &mdash; introducing variation '+
          'while preserving the aesthetic DNA you selected for.'+
        '</p>'+
        '<div class="ig-crossover">'+
          '<div class="ig-par">'+
            '<img src="data:image/png;base64,'+d.parent_a+'" alt="Parent A">'+
            '<div class="lbl">Parent A</div>'+
          '</div>'+
          '<div class="ig-sym">\u00d7</div>'+
          '<div class="ig-par">'+
            '<img src="data:image/png;base64,'+d.parent_b+'" alt="Parent B">'+
            '<div class="lbl">Parent B</div>'+
          '</div>'+
          '<div class="ig-sym">\u2192</div>'+
          '<div class="ig-child-wrap">'+
            '<img src="data:image/png;base64,'+d.child_demo+'" alt="Offspring">'+
            '<div class="lbl">Offspring</div>'+
          '</div>'+
        '</div>'+
        '<div class="ig-math">'+
          '<span class="ig-math-label">Uniform Crossover (rate <span class="v">p</span> = 0.7)</span>'+
          'For each shape group <span class="v">i</span>:<br>'+
          '&nbsp;&nbsp;<span class="v">child</span>.<span class="v">group\u1d62</span> <span class="op">=</span> '+
          '<span class="v">parentA</span>.<span class="v">group\u1d62</span> &nbsp;with prob 0.5<br>'+
          '&nbsp;&nbsp;<span class="v">child</span>.<span class="v">group\u1d62</span> <span class="op">=</span> '+
          '<span class="v">parentB</span>.<span class="v">group\u1d62</span> &nbsp;with prob 0.5'+
        '</div>'+
        '<div class="ig-math">'+
          '<span class="ig-math-label">Gaussian Mutation</span>'+
          'For each continuous parameter <span class="v">x</span>:<br>'+
          '&nbsp;&nbsp;<span class="v">x\u2032</span> <span class="op">=</span> clamp( <span class="v">x</span> + '+
          '<span class="v">N</span>(0, <span class="v">\u03c3</span>\u00b2) , 0, 1 )<br>'+
          '&nbsp;&nbsp;<span class="v">\u03c3</span> <span class="op">=</span> <span class="v">mutation_strength</span> '+
          '\u00d7 <span class="v">base_range</span><br>'+
          '<br>'+
          'Discrete params (shape kind, color index) mutate via random replacement with prob <span class="v">p</span>'+
        '</div>'+
      '</div>'+
      '<div class="ig-connector"><span></span></div>'+
      '<div class="ig-step">'+
        '<div class="ig-step-head">'+
          '<div class="ig-step-num dark">04</div>'+
          '<h4>Next Generation &mdash; The Cycle Continues</h4>'+
        '</div>'+
        '<p class="ig-step-desc">'+
          'The offspring form a new population. Each generation inherits visual traits from compositions '+
          'you found compelling, while mutations introduce unexpected variations &mdash; a '+
          '<strong>directed random walk through aesthetic space</strong>, guided entirely by your taste.'+
        '</p>'+
        '<div class="ig-grid">'+
          d.children.map(function(b,i){
            return '<div class="ig-img"><img src="data:image/png;base64,'+b+'" alt="Child '+i+'"></div>';
          }).join('')+
        '</div>'+
        '<div class="ig-math">'+
          '<span class="ig-math-label">The Evolutionary Loop</span>'+
          '<span class="kw">repeat</span> {<br>'+
          '&nbsp;&nbsp;render(<span class="v">population</span>)<br>'+
          '&nbsp;&nbsp;<span class="v">selected</span> <span class="op">\u2190</span> user_picks(<span class="v">thumbnails</span>)<br>'+
          '&nbsp;&nbsp;<span class="v">parents</span> <span class="op">\u2190</span> tournament_select(<span class="v">population</span>, <span class="v">selected</span>)<br>'+
          '&nbsp;&nbsp;<span class="v">offspring</span> <span class="op">\u2190</span> crossover(<span class="v">parents</span>) <span class="op">\u2295</span> mutate(<span class="v">\u03c3</span>)<br>'+
          '&nbsp;&nbsp;<span class="v">population</span> <span class="op">\u2190</span> <span class="v">offspring</span> <span class="op">\u222a</span> elite(<span class="v">population</span>)<br>'+
          '}'+
        '</div>'+
      '</div>';
  }catch(e){
    box.innerHTML = '<div class="ig-loading">Could not load demo &mdash; start the server and refresh.</div>';
  }
}

function refreshHomeLive(data){
  const live = (data.thumbnails || []).slice(0, 8);
  renderHomeGallery(homeLiveGrid, live);
  homeGen.textContent = String(data.generation);
  homePop.textContent = String(data.pop_size);
  homeLiveMeta.textContent = `Preview from generation ${data.generation}.`;
  updateEngineUI(data.engine || 'shapes');
}

function renderGrid(data){
  genNum.textContent = data.generation;
  thumbnails = data.thumbnails || [];
  popSize = data.pop_size || 0;
  selected.clear();
  grid.innerHTML = '';

  if(data.mutation_strength !== undefined){
    slMutation.value = data.mutation_strength;
    mutationVal.textContent = Number(data.mutation_strength).toFixed(1);
  }
  if(data.crossover_rate !== undefined){
    slCrossover.value = data.crossover_rate;
    crossoverVal.textContent = Number(data.crossover_rate).toFixed(2);
  }
  if(data.grain_strength !== undefined){
    slGrain.value = data.grain_strength;
    grainVal.textContent = Math.round(data.grain_strength);
  }
  if(data.gradient_strength !== undefined){
    slGradient.value = data.gradient_strength;
    gradientVal.textContent = Math.round(data.gradient_strength);
  }

  updateNavUI(data);

  thumbnails.forEach((b64, i) => {
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.innerHTML = `
      <img src="data:image/png;base64,${b64}" alt="Individual ${i}">
      <span class="idx">${i}</span>
      <span class="check">
        <svg viewBox="0 0 16 16" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3,8 7,12 13,4"></polyline>
        </svg>
      </span>
    `;
    cell.addEventListener('click', () => {
      if(selected.has(i)) selected.delete(i); else selected.add(i);
      updateSelectionUI();
    });
    grid.appendChild(cell);
  });

  updateSelectionUI();
  refreshHomeLive(data);
}

async function loadState(){
  const data = await apiFetch('/api/state');
  updateEngineUI(data.engine || 'shapes');
  selMode.value = data.mode;
  selPalette.value = data.palette;
  selColor.value = data.color_mode;
  renderGrid(data);
  evolveLoaded = true;
}

async function loadHomeContent(forceSampleRefresh = false){
  const statePromise = apiFetch('/api/state', undefined, false);
  const samplesPromise = (!homeSamplesCache || forceSampleRefresh)
    ? apiFetch('/api/home_samples', undefined, false)
    : Promise.resolve(homeSamplesCache);

  const [stateData, samples] = await Promise.all([statePromise, samplesPromise]);
  homeSamplesCache = samples;
  refreshHomeLive(stateData);
  renderHomeGallery(homeMalevichGrid, samples.malevich || []);
  renderHomeGallery(homeHadidGrid, samples.hadid || []);
  renderHomeGallery(homeMapsGrid, samples.maps || []);
  loadInfographic(forceSampleRefresh);
}

function routeFromPath(pathname){
  return pathname.startsWith('/evolve') ? 'evolve' : 'home';
}

async function setRoute(route, push = true){
  activeRoute = route;
  pageHome.classList.toggle('active', route === 'home');
  pageEvolve.classList.toggle('active', route === 'evolve');
  routeLinks.forEach(link => link.classList.toggle('active', link.dataset.route === route));

  if(push){
    const target = route === 'evolve' ? '/evolve' : '/';
    if(window.location.pathname !== target){
      history.pushState({ route }, '', target);
    }
  }

  if(route === 'home'){
    await loadHomeContent();
  } else if(!evolveLoaded){
    await loadState();
  }
}

function sendSettings(patch){
  return apiFetch('/api/settings', patch);
}

advToggle.addEventListener('click', () => {
  advToggle.classList.toggle('open');
  advBody.classList.toggle('open');
});

slMutation.addEventListener('input', () => {
  mutationVal.textContent = Number(slMutation.value).toFixed(1);
});
slMutation.addEventListener('change', async () => {
  await sendSettings({ mutation_strength: parseFloat(slMutation.value) });
});

slCrossover.addEventListener('input', () => {
  crossoverVal.textContent = Number(slCrossover.value).toFixed(2);
});
slCrossover.addEventListener('change', async () => {
  await sendSettings({ crossover_rate: parseFloat(slCrossover.value) });
});

slGrain.addEventListener('input', () => {
  grainVal.textContent = Math.round(slGrain.value);
});
slGrain.addEventListener('change', async () => {
  const data = await sendSettings({ grain_strength: parseFloat(slGrain.value) });
  renderGrid(data);
});

slGradient.addEventListener('input', () => {
  gradientVal.textContent = Math.round(slGradient.value);
});
slGradient.addEventListener('change', async () => {
  const data = await sendSettings({ gradient_strength: parseFloat(slGradient.value) });
  renderGrid(data);
});

btnPrev.addEventListener('click', async () => {
  const data = await apiFetch('/api/prev', {});
  renderGrid(data);
});

btnNext.addEventListener('click', async () => {
  const data = await apiFetch('/api/next', {});
  renderGrid(data);
});

btnEvolve.addEventListener('click', async () => {
  const data = await apiFetch('/api/evolve', { selected: [...selected] });
  renderGrid(data);
});

async function doExport(orientation) {
  const idx = [...selected][0];
  showLoading();
  try {
    const data = await apiFetch('/api/export', { index: idx, orientation });
    const src = 'data:image/png;base64,' + data.image;
    modalImg.src = src;
    modalDownload.href = src;
    const suffix = orientation !== 'square' ? `_${orientation}` : '';
    modalDownload.download = `hires_${genNum.textContent.padStart(4, '0')}_${String(idx).padStart(2, '0')}${suffix}.png`;
    modalBackdrop.classList.remove('hidden');
  } finally {
    hideLoading();
  }
}

btnExport.addEventListener('click', () => doExport('square'));
btnExportLand.addEventListener('click', () => doExport('landscape'));
btnExportPort.addEventListener('click', () => doExport('portrait'));

btnExportAll.addEventListener('click', async () => {
  showLoading();
  try {
    const res = await fetch('/api/export_all');
    if(!res.ok) throw new Error(`Export failed: ${res.status}`);
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `gen${genNum.textContent.padStart(4, '0')}_all.zip`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  } finally {
    hideLoading();
  }
});

btnSave.addEventListener('click', async () => {
  const idx = [...selected][0];
  const data = await apiFetch('/api/save', { index: idx });
  selInfo.textContent = `Genome saved: ${data.path}`;
});

btnReset.addEventListener('click', async () => {
  const data = await apiFetch('/api/reset', {
    engine: selEngine.value,
    mode: selMode.value,
    palette: selPalette.value,
    color_mode: selColor.value,
    pop_size: 24,
    mutation_strength: parseFloat(slMutation.value),
    crossover_rate: parseFloat(slCrossover.value)
  });
  updateEngineUI(data.engine || selEngine.value);
  renderGrid(data);
});

selEngine.addEventListener('change', () => updateEngineUI(selEngine.value));

modalClose.addEventListener('click', () => modalBackdrop.classList.add('hidden'));
modalBackdrop.addEventListener('click', e => {
  if(e.target === modalBackdrop) modalBackdrop.classList.add('hidden');
});

routeLinks.forEach(link => {
  link.addEventListener('click', async e => {
    e.preventDefault();
    await setRoute(link.dataset.route, true);
  });
});

homeStart.addEventListener('click', async () => {
  await setRoute('evolve', true);
});
homeGoEvolve.addEventListener('click', async () => {
  await setRoute('evolve', true);
});
homeRefresh.addEventListener('click', async () => {
  await loadHomeContent(true);
});
document.getElementById('ig-regen-btn').addEventListener('click', () => {
  loadInfographic(true);
});

window.addEventListener('popstate', async () => {
  await setRoute(routeFromPath(window.location.pathname), false);
});

document.addEventListener('keydown', e => {
  if(activeRoute !== 'evolve') return;
  if(e.key === 'Enter' && !btnEvolve.disabled && loading.classList.contains('hidden')){
    btnEvolve.click();
  }
  if(e.key === 'Escape'){
    modalBackdrop.classList.add('hidden');
  }
  if(e.key === 'ArrowLeft' && !btnPrev.disabled && loading.classList.contains('hidden')){
    btnPrev.click();
  }
  if(e.key === 'ArrowRight' && !btnNext.disabled && loading.classList.contains('hidden')){
    btnNext.click();
  }
});

(async function init(){
  await setRoute(routeFromPath(window.location.pathname), false);
})();
</script>
</body>
</html>
